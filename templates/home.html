
{% extends 'base.html' %}
{% block title %}ReFindr - Find Academic Papers{% endblock %}
{% block content %}
<div class="min-h-screen" style="background-color: #fef7e0">
  <section class="pt-24 pb-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      {% if user.is_authenticated %}
      <h1 class="text-4xl md:text-5xl font-bold text-amber-900 mb-4">
        Welcome back, {{ user.username }}!
      </h1>
      <p class="text-lg text-amber-800 mb-2 max-w-2xl mx-auto">
        Continue your research journey and explore new papers.
      </p>
      {% else %}
      <h1 class="text-4xl md:text-5xl font-bold text-amber-900 mb-4">
        Search Academic Papers Across Multiple Databases
      </h1>
      <p class="text-lg text-amber-800 mb-12 max-w-2xl mx-auto">
        Find research papers from your favorite academic sources all in one
        place.
      </p>
      {% endif %}
    </div>
  </section>

  <section class="pb-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <form method="GET" action="{% url 'home' %}" id="searchForm" class="mb-8">
        <div class="relative mb-6">
          <div class="relative search-autocomplete-container">
            <input
              type="text"
              name="query"
              id="searchInput"
              placeholder="Search for research papers..."
              class="w-full px-6 py-4 text-lg text-gray-900 rounded-2xl border-2 border-amber-200 focus:border-amber-900 focus:ring-0 shadow-sm bg-white search-input"
              value="{{ query|default:'' }}"
              autocomplete="off"
            />
            <button
              type="submit"
              class="absolute right-2 top-3 bg-amber-900 hover:bg-amber-800 text-white px-6 py-2 rounded-xl transition-colors"
            >
              <i class="fas fa-search"></i>
            </button>
            <!-- Autocomplete dropdown -->
            <div id="autocompleteDropdown" class="absolute top-full left-0 right-0 bg-white border border-amber-200 rounded-lg shadow-lg z-10 hidden max-h-60 overflow-y-auto">
              <!-- Suggestions will be populated here -->
            </div>
          </div>
        </div>

        <!-- Suggested Keywords Section -->
        <!-- {% if suggested_keywords %}
<div class="mb-6">
  <h3 class="text-sm font-medium text-amber-900 mb-3">
    <i class="fas fa-lightbulb mr-2" aria-hidden="true"></i>Suggested Keywords:
  </h3> -->

  <!-- allow chips to wrap to next line -->
  <!-- <div class="flex flex-wrap gap-2 items-center py-1" role="list" aria-label="Suggested keywords">
    {% for keyword in suggested_keywords|slice:":5" %}
      <button
        type="button"
        class="keyword-chip bg-amber-50 hover:bg-amber-100 text-amber-800 px-3 py-1 rounded-full text-sm border border-amber-200 transition-colors"
        data-keyword="{{ keyword }}"
        role="listitem"
      >
        {{ keyword }}
      </button>
    {% endfor %}
  </div>
</div>


{% endif %} -->


        <div class="mb-8">
  <h3 class="text-lg font-semibold text-amber-900 mb-4">
    Select Sources to Search:
  </h3>

  <div class="flex flex-wrap gap-3">
    {% for source in available_sources %}
        <!-- Checkbox: hidden -->
        <input
          type="checkbox"
          name="sources"
          value="{{ source.id }}"
          id="source-{{ source.id }}"
          class="hidden source-checkbox"
          {% if source.id|stringformat:"s" in selected_sources %}checked{% endif %}
        />

        <!-- Label styled as button -->
        <label
          for="source-{{ source.id }}"
          class="source-label bg-white text-amber-700 border-2 border-amber-200 px-6 py-3 rounded-full cursor-pointer font-medium transition-all hover:bg-amber-900 hover:text-white hover:border-amber-900"
        >
          <i class="{{ source.icon }} mr-2"></i>{{ source.name }}
          {% if not source.free %}
            <i class="fas fa-crown text-yellow-500 ml-1" title="Premium API required"></i>
          {% endif %}
        </label>
    {% empty %}
      <p class="text-sm text-red-600">No sources available.</p>
    {% endfor %}
  </div>

  <p class="text-sm text-amber-700 mt-3">
    <i class="fas fa-info-circle mr-2"></i>
    Select at least one source. Free sources work without API keys.
  </p>
</div>

      </form>
    </div>
  </section>

  <!-- {% if search_stats %}
  <section class="pb-8 -mt-4">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="bg-white rounded-xl p-4 border border-amber-200 shadow-md">
        <h4 class="font-semibold text-amber-900 mb-2">
          Search Results Summary:
        </h4>
        <div class="flex flex-wrap gap-4 text-sm">
          {% for source, stats in search_stats.items %}
          <div class="flex items-center">
            <span class="font-medium">{{ source|title }}:</span>
            {% if stats.error %}
            <span class="text-red-600 ml-1">{{ stats.error }}</span>
            {% else %}
            <span class="text-green-600 ml-1">{{ stats.count }} papers</span>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </section>
  {% endif %} -->

  {% if papers %}
  <section class="pb-16">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-2xl font-bold text-amber-900 mb-8">
        Search Results for "{{ query }}" ({{ papers|length }} papers found)
      </h2>
      <div class="grid gap-6">
        {% for paper in papers %}
        <div class="bg-white border border-amber-200 rounded-xl p-6 transition-all paper-card-hover">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-900 mb-2 sm:mb-0 flex-1 pr-4">
              <a
                href="{{ paper.link }}"
                target="_blank"
                rel="noopener noreferrer"
                class="hover:text-amber-900 transition-colors"
              >
                {{ paper.title }}
              </a>
            </h3>
            <div class="flex flex-row sm:flex-col items-center sm:items-end gap-2">
              <span class="bg-amber-100 text-amber-900 text-xs px-3 py-1 rounded-full whitespace-nowrap font-semibold">
                {{ paper.category }}
              </span>
              <span class="text-xs text-gray-600 flex items-center">
                <i class="{{ paper.source_icon }} mr-1 text-amber-700"></i>
                {{ paper.source }}
              </span>
            </div>
          </div>
          <div class="text-gray-600 mb-3 text-sm">
            <i class="fas fa-user mr-2 text-amber-700"></i>
            <strong class="text-amber-900">Authors:</strong>
            {% if paper.authors %}
              {{ paper.authors|join:", " }}
            {% else %}
              Unknown
            {% endif %}
          </div>
          <div class="flex flex-wrap items-center gap-x-6 gap-y-2 text-gray-600 mb-3 text-sm">
            <div>
              <i class="fas fa-calendar mr-2 text-amber-700"></i>
              <strong class="text-amber-900">Published:</strong> {{ paper.published }}
            </div>
            {% if paper.citation_count %}
            <div>
              <i class="fas fa-quote-right mr-2 text-amber-700"></i>
              <strong class="text-amber-900">Citations:</strong> {{ paper.citation_count }}
            </div>
            {% endif %}
          </div>
          <p class="text-gray-700 mb-4 leading-relaxed text-base">
            {{ paper.summary|truncatewords:50 }}
          </p>
          <div class="flex flex-col sm:flex-row justify-between items-center gap-3 mt-4">
            <a
              href="{{ paper.link }}"
              target="_blank"
              rel="noopener noreferrer"
              class="text-amber-900 hover:text-amber-800 font-medium flex items-center"
            >
              <i class="fas fa-external-link-alt mr-1"></i>
              View Full Paper
            </a>
            <div class="flex gap-3">
              {% if user.is_authenticated %}
              <button
                type="button"
                class="bg-amber-100 hover:bg-amber-200 text-amber-900 px-4 py-2 rounded-lg transition-colors text-sm flex items-center open-bookmark-modal"
                data-title="{{ paper.title }}"
                data-author="{{ paper.authors|join:', ' }}"
                data-link="{{ paper.link }}"
                data-published="{{ paper.published }}"
                data-category="{{ paper.category }}"
                data-citation="{{ paper.citation_count|default:0 }}"
              >
                <i class="fas fa-bookmark mr-1"></i>
                Save
              </button>
              {% else %}
              <a href="{% url 'login' %}?next={{ request.get_full_path|urlencode }}%26modal=true%26title={{ paper.title|urlencode }}%26link={{ paper.link|urlencode }}%26author={{ paper.authors|join:', '|urlencode }}%26published={{ paper.published|urlencode }}%26category={{ paper.category|urlencode }}%26citation={{ paper.citation_count|default:0 }}"
                 class="bg-amber-100 hover:bg-amber-200 text-amber-900 px-4 py-2 rounded-lg transition-colors text-sm flex items-center"
                 onclick="sessionStorage.setItem('scrollPos', window.scrollY)"
              >
                <i class="fas fa-bookmark mr-1"></i>
                Save
              </a>
              {% endif %}
              {% if paper.pdf_link %}
              <button
                onclick="openPDFModal('{{ paper.pdf_link }}')"
                class="bg-amber-900 hover:bg-amber-800 text-white px-4 py-2 rounded-lg transition-colors text-sm flex items-center"
              >
                <i class="fas fa-file-pdf mr-1"></i>
                View PDF
              </button>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>
  {% elif query %}
  <section class="pb-16">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <div class="bg-white rounded-xl p-8 border border-amber-200 shadow-md">
        <i class="fas fa-search text-4xl text-amber-300 mb-4"></i>
        <h3 class="text-xl font-semibold text-amber-900 mb-2">
          No Results Found
        </h3>
        <p class="text-amber-700">
          Try adjusting your search terms or selecting different sources.
        </p>
      </div>
    </div>
  </section>
  {% endif %}
</div>

<!-- Bookmark Modal -->
<div id="bookmarkModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
    <h3 class="text-lg font-semibold text-amber-900 mb-4">
      Save to Bookmark List
    </h3>
    <form method="POST" action="{% url 'add_bookmark' list_id=0 %}" id="bookmarkForm">
      {% csrf_token %}
      <input type="hidden" name="title" id="modal-title" />
      <input type="hidden" name="author" id="modal-author" />
      <input type="hidden" name="link" id="modal-link" />
      <input type="hidden" name="published" id="modal-published" />
      <input type="hidden" name="category" id="modal-category" />
      <input type="hidden" name="citation_count" id="modal-citation" />

      <label class="block text-sm font-medium text-gray-700 mb-2">Select a List</label>
      <select
        name="list_id"
        id="modal-list-id"
        required
        class="w-full border border-gray-300 rounded-lg mb-3 px-4 py-2"
      >
        {% for blist in bookmark_lists %}
        <option value="{{ blist.id }}">{{ blist.name }}</option>
        {% empty %}
        <option disabled>No bookmark lists available</option>
        {% endfor %}
      </select>

      <div class="flex items-center gap-2 mb-4">
        <input
          type="text"
          id="new-list-name"
          class="flex-grow border border-gray-300 rounded-lg px-3 py-2 text-sm"
          placeholder="New list name (optional)"
        />
        <button
          type="button"
          id="createListBtn"
          class="bg-amber-800 text-white px-4 py-2 rounded-lg text-sm"
        >
          Create
        </button>
      </div>

      <div class="flex justify-end gap-3">
        <button
          type="button"
          id="cancelBookmark"
          class="text-gray-500 hover:text-gray-800"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="bg-amber-900 hover:bg-amber-800 text-white px-4 py-2 rounded-lg text-sm"
        >
          Save
        </button>
      </div>
    </form>
  </div>
</div>

<!-- PDF Modal -->
<div id="pdfModalBackdrop" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-xl border border-amber-200 w-full max-w-6xl max-h-[90vh] relative flex flex-col">
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-200 flex-shrink-0">
      <h3 class="text-lg font-semibold text-gray-900">PDF Viewer</h3>
      <button onclick="closePDFModal()" class="text-gray-400 hover:text-gray-600 text-xl">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <!-- Loading indicator -->
    <div id="pdfLoading" class="hidden flex items-center justify-center p-8">
      <div class="flex items-center gap-3">
        <i class="fas fa-spinner fa-spin text-amber-900 text-xl"></i>
        <span class="text-amber-900">Loading PDF...</span>
      </div>
    </div>
    
    <!-- PDF Content -->
    <!-- PDF Modal Backdrop -->
<div id="pdfModalBackdrop" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-60 overflow-auto">
  <!-- Modal Content -->
  <div class="bg-white rounded-lg shadow-lg max-w-5xl w-full mx-auto my-8 relative flex flex-col max-h-[90vh] overflow-hidden">
    
    <!-- Close Button -->
    <button onclick="closePDFModal()" class="absolute top-3 right-3 text-gray-500 hover:text-red-600 text-2xl font-bold z-10">
      &times;
    </button>

    <!-- Modal Inner Content -->
    <div class="flex-1 overflow-hidden flex flex-col">
      
      <!-- Canvas Container -->
      <div class="flex-1 overflow-auto bg-gray-50 p-4">
        <div class="flex justify-center">
          <canvas id="pdfCanvas" class="border border-gray-200 rounded-lg shadow-sm max-w-full h-auto"></canvas>
        </div>
      </div>
      
      <!-- Navigation & Zoom Controls -->
      <div class="flex items-center justify-between p-4 border-t border-gray-200 bg-gray-50 flex-shrink-0">
        <button onclick="prevPage()" class="px-4 py-2 bg-amber-900 text-white rounded-lg hover:bg-amber-800 disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
          <i class="fas fa-chevron-left mr-2"></i>Previous
        </button>
        
        <div class="flex items-center gap-4">
          <span class="text-sm text-amber-800">
            Page <span id="page-num">1</span> of <span id="page-count">?</span>
          </span>
          
          <!-- Zoom Controls -->
          <div class="flex items-center gap-2">
            <button onclick="zoomOut()" class="p-2 text-amber-900 hover:bg-amber-100 rounded" title="Zoom Out">
              <i class="fas fa-search-minus"></i>
            </button>
            <span class="text-sm text-gray-600" id="zoom-level">100%</span>
            <button onclick="zoomIn()" class="p-2 text-amber-900 hover:bg-amber-100 rounded" title="Zoom In">
              <i class="fas fa-search-plus"></i>
            </button>
          </div>
        </div>
        
        <button onclick="nextPage()" class="px-4 py-2 bg-amber-900 text-white rounded-lg hover:bg-amber-800 disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
          Next<i class="fas fa-chevron-right ml-2"></i>
        </button>
      </div>
    </div>
  </div>
</div>


<style>
  body {
    background-color: #f5f1e8;
  }
  .search-input:focus {
    box-shadow: 0 0 0 3px rgba(120, 53, 15, 0.2);
  }
  .source-label-hover:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.1);
  }
  .paper-card-hover:hover {
    box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.1),
      0 2px 4px -2px rgba(0, 0, 0, 0.06);
    border-color: #fcd34d;
  }
  
  /* Checkbox styling */
  .source-checkbox:checked + .source-label {
    background-color: #78350f !important;
    color: white !important;
    border-color: #78350f !important;
  }
  
  /* Autocomplete styles */
  .search-autocomplete-container {
    position: relative;
  }
  
  #autocompleteDropdown {
    border-top: none;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    margin-top: -1px;
  }
  
  .autocomplete-item {
    padding: 12px 16px;
    cursor: pointer;
    border-bottom: 1px solid #f3f4f6;
    transition: background-color 0.2s;
  }
  
  .autocomplete-item:hover,
  .autocomplete-item.highlighted {
    background-color: #fef3c7;
    color: #78350f;
  }
  
  .autocomplete-item:last-child {
    border-bottom: none;
  }
  
  .autocomplete-item .suggestion-type {
    font-size: 0.75rem;
    color: #9ca3af;
    margin-left: 8px;
  }
  
  .keyword-suggestion:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px -2px rgba(0, 0, 0, 0.1);
  }

  #pdfModalBackdrop {
    backdrop-filter: blur(4px);
  }

  #pdfCanvas {
    transition: transform 0.2s ease;
  }

  /* Loading spinner for PDF */
  .pdf-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
  }

  /* Smooth scrolling for PDF container */
  .pdf-container {
    scroll-behavior: smooth;
  }
</style>
<script>
let pdfDoc = null;
let pageNum = 1;
let pageRendering = false;
let pageNumPending = null;
let scale = 1.0;
let canvas = null;
let ctx = null;
let pdfjsLoaded = false;
let pdfjsLib = null;

function loadPDFJS() {
  return new Promise((resolve, reject) => {
    if (pdfjsLoaded) {
      resolve();
      return;
    }

    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
    script.onload = function () {
      pdfjsLib = window['pdfjsLib'];
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      pdfjsLoaded = true;
      resolve();
    };
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

function openPDFModal(pdfUrl) {
  const modal = document.getElementById('pdfModalBackdrop');
  const loadingDiv = document.getElementById('pdfLoading');
  canvas = document.getElementById('pdfCanvas');

  if (!modal || !loadingDiv || !canvas) {
    console.error('Required modal elements not found.');
    return;
  }

  ctx = canvas.getContext('2d');
  modal.classList.remove('hidden');
  loadingDiv.classList.remove('hidden');

  loadPDFJS().then(() => {
    const container = canvas.parentElement;
    const containerWidth = container.clientWidth - 32;

    return pdfjsLib.getDocument(pdfUrl).promise;
  }).then(pdf => {
    pdfDoc = pdf;
    document.getElementById('page-count').textContent = pdf.numPages;
    return pdf.getPage(1);
  }).then(page => {
    const viewport = page.getViewport({ scale: 1.0 });
    const containerWidth = canvas.parentElement.clientWidth - 32;
    scale = Math.min(containerWidth / viewport.width, 1.5);
    updateZoomLevel();
    document.getElementById('pdfLoading').classList.add('hidden');
    renderPage(pageNum);
  }).catch(error => {
    console.error('Error loading PDF:', error);
    alert('Failed to load PDF.');
    closePDFModal();
  });
}

function closePDFModal() {
  const modal = document.getElementById('pdfModalBackdrop');
  const loadingDiv = document.getElementById('pdfLoading');

  modal.classList.add('hidden');
  loadingDiv.classList.add('hidden');

  if (canvas) {
    canvas.width = 0;
    canvas.height = 0;
  }

  pdfDoc = null;
  pageNum = 1;
  pageRendering = false;
  pageNumPending = null;
  scale = 1.0;
}

function renderPage(num) {
  if (!pdfDoc) return;
  pageRendering = true;

  pdfDoc.getPage(num).then(page => {
    const viewport = page.getViewport({ scale });
    canvas.height = viewport.height;
    canvas.width = viewport.width;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const renderContext = {
      canvasContext: ctx,
      viewport
    };

    return page.render(renderContext).promise;
  }).then(() => {
    pageRendering = false;
    if (pageNumPending !== null) {
      renderPage(pageNumPending);
      pageNumPending = null;
    }
    updateNavigationButtons();
  }).catch(error => {
    console.error('Error rendering page:', error);
    pageRendering = false;
  });

  document.getElementById('page-num').textContent = num;
}

function queueRenderPage(num) {
  if (pageRendering) {
    pageNumPending = num;
  } else {
    renderPage(num);
  }
}

function prevPage() {
  if (!pdfDoc || pageNum <= 1) return;
  pageNum--;
  queueRenderPage(pageNum);
}

function nextPage() {
  if (!pdfDoc || pageNum >= pdfDoc.numPages) return;
  pageNum++;
  queueRenderPage(pageNum);
}

function zoomIn() {
  scale = Math.min(scale * 1.2, 3.0);
  updateZoomLevel();
  queueRenderPage(pageNum);
}

function zoomOut() {
  scale = Math.max(scale / 1.2, 0.5);
  updateZoomLevel();
  queueRenderPage(pageNum);
}

function updateZoomLevel() {
  document.getElementById('zoom-level').textContent = Math.round(scale * 100) + '%';
}

function updateNavigationButtons() {
  const prevBtn = document.querySelector('button[onclick="prevPage()"]');
  const nextBtn = document.querySelector('button[onclick="nextPage()"]');

  if (prevBtn) prevBtn.disabled = pageNum <= 1;
  if (nextBtn) nextBtn.disabled = pageNum >= pdfDoc.numPages;
}

window.addEventListener('resize', () => {
  if (pdfDoc && !document.getElementById('pdfModalBackdrop').classList.contains('hidden')) {
    const containerWidth = canvas.parentElement.clientWidth - 32;
    pdfDoc.getPage(1).then(page => {
      const viewport = page.getViewport({ scale: 1.0 });
      const optimalScale = Math.min(containerWidth / viewport.width, 1.5);
      if (Math.abs(scale - optimalScale) > 0.1) {
        scale = optimalScale;
        updateZoomLevel();
        queueRenderPage(pageNum);
      }
    });
  }
});

document.addEventListener('keydown', function (e) {
  if (!document.getElementById('pdfModalBackdrop').classList.contains('hidden')) {
    switch (e.key) {
      case 'ArrowLeft': e.preventDefault(); prevPage(); break;
      case 'ArrowRight': e.preventDefault(); nextPage(); break;
      case 'Escape': e.preventDefault(); closePDFModal(); break;
      case '+':
      case '=': if (e.ctrlKey || e.metaKey) { e.preventDefault(); zoomIn(); } break;
      case '-': if (e.ctrlKey || e.metaKey) { e.preventDefault(); zoomOut(); } break;
    }
  }
});

document.addEventListener("DOMContentLoaded", function () {
  // Initialize checkbox states
  function initializeCheckboxes() {
    document.querySelectorAll('.source-checkbox').forEach(checkbox => {
      const label = document.querySelector(`label[for="${checkbox.id}"]`);
      if (checkbox.checked) {
        label.classList.add('bg-amber-900', 'text-white', 'border-amber-900');
        label.classList.remove('bg-white', 'text-amber-700', 'border-amber-200');
      }
      
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          label.classList.add('bg-amber-900', 'text-white', 'border-amber-900');
          label.classList.remove('bg-white', 'text-amber-700', 'border-amber-200');
        } else {
          label.classList.remove('bg-amber-900', 'text-white', 'border-amber-900');
          label.classList.add('bg-white', 'text-amber-700', 'border-amber-200');
        }
      });
    });
  }
  
  // Initialize checkboxes on page load
  initializeCheckboxes();

  // Load PDF.js library
  const script = document.createElement('script');
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
  script.onload = function() {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  };
  document.head.appendChild(script);

  // Autocomplete functionality
  const searchInput = document.getElementById('searchInput');
  const autocompleteDropdown = document.getElementById('autocompleteDropdown');
  let currentSuggestions = [];
  let highlightedIndex = -1;
  let autocompleteTimeout;

  // Function to fetch autocomplete suggestions
  async function fetchSuggestions(term) {
    if (term.length < 2) {
      hideAutocomplete();
      return;
    }

    try {
      const response = await fetch(`/autocomplete-suggestions/?term=${encodeURIComponent(term)}`);
      const data = await response.json();
      currentSuggestions = data.suggestions || [];
      showAutocomplete(currentSuggestions);
    } catch (error) {
      console.error('Error fetching suggestions:', error);
      hideAutocomplete();
    }
  }

  // Function to show autocomplete dropdown
  function showAutocomplete(suggestions) {
    if (suggestions.length === 0) {
      hideAutocomplete();
      return;
    }

    autocompleteDropdown.innerHTML = '';
    
    suggestions.forEach((suggestion, index) => {
      const item = document.createElement('div');
      item.className = 'autocomplete-item';
      item.innerHTML = `
        <span>${suggestion}</span>
        <span class="suggestion-type">${suggestion.includes(' ') ? 'keyword' : 'query'}</span>
      `;
      
      item.addEventListener('click', () => {
        selectSuggestion(suggestion);
      });
      
      autocompleteDropdown.appendChild(item);
    });

    autocompleteDropdown.classList.remove('hidden');
    highlightedIndex = -1;
  }

  // Function to hide autocomplete dropdown
  function hideAutocomplete() {
    autocompleteDropdown.classList.add('hidden');
    highlightedIndex = -1;
  }

  // Function to select a suggestion
  function selectSuggestion(suggestion) {
    searchInput.value = suggestion;
    hideAutocomplete();
    searchInput.focus();
  }

  // Function to highlight suggestion with keyboard
  function highlightSuggestion(index) {
    const items = autocompleteDropdown.querySelectorAll('.autocomplete-item');
    
    // Remove previous highlight
    items.forEach(item => item.classList.remove('highlighted'));
    
    // Add highlight to current item
    if (index >= 0 && index < items.length) {
      items[index].classList.add('highlighted');
      highlightedIndex = index;
    }
  }

  // Search input event listeners
  searchInput.addEventListener('input', function() {
    const term = this.value.trim();
    
    // Clear previous timeout
    if (autocompleteTimeout) {
      clearTimeout(autocompleteTimeout);
    }
    
    // Debounce the search
    autocompleteTimeout = setTimeout(() => {
      fetchSuggestions(term);
    }, 300);
  });

  // Keyboard navigation for autocomplete
  searchInput.addEventListener('keydown', function(e) {
    const items = autocompleteDropdown.querySelectorAll('.autocomplete-item');
    
    switch(e.key) {
      case 'ArrowDown':
        e.preventDefault();
        if (items.length > 0) {
          highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
          highlightSuggestion(highlightedIndex);
        }
        break;
        
      case 'ArrowUp':
        e.preventDefault();
        if (items.length > 0) {
          highlightedIndex = Math.max(highlightedIndex - 1, -1);
          if (highlightedIndex >= 0) {
            highlightSuggestion(highlightedIndex);
          } else {
            items.forEach(item => item.classList.remove('highlighted'));
          }
        }
        break;
        
      case 'Enter':
        if (highlightedIndex >= 0 && items.length > 0) {
          e.preventDefault();
          const selectedText = items[highlightedIndex].querySelector('span').textContent;
          selectSuggestion(selectedText);
        }
        break;
        
      case 'Escape':
        hideAutocomplete();
        break;
    }
  });

  // Hide autocomplete when clicking outside
  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !autocompleteDropdown.contains(e.target)) {
      hideAutocomplete();
    }
  });

  // Keyword suggestion buttons
  document.querySelectorAll('.keyword-suggestion').forEach(button => {
    button.addEventListener('click', function() {
      const keyword = this.dataset.keyword;
      const currentValue = searchInput.value.trim();
      
      // Add keyword to search if not already present
      if (!currentValue.toLowerCase().includes(keyword.toLowerCase())) {
        const newValue = currentValue ? `${currentValue} ${keyword}` : keyword;
        searchInput.value = newValue;
        searchInput.focus();
      }
    });
  });

  // Form validation
  const form = document.getElementById("searchForm");
  form.addEventListener("submit", function (e) {
    const checkedSources = document.querySelectorAll(
      'input[name="sources"]:checked'
    );
    if (checkedSources.length === 0) {
      e.preventDefault();
      alert("Please select at least one source to search.");
    }
  });

  // Function to safely encode URL parameters
  function safeEncodeURIComponent(str) {
    if (!str) return '';
    return encodeURIComponent(str.toString());
  }

  // Update bookmark form action
  function updateBookmarkFormAction(listId) {
    const form = document.getElementById("bookmarkForm");
    const baseUrl = "{% url 'add_bookmark' list_id=0 %}";
    form.action = baseUrl.replace("0", listId);
  }

  // Success toast notification function
  function showToast(message, type = "success") {
    // Remove any existing toasts first
    const existingToasts = document.querySelectorAll('.toast-notification');
    existingToasts.forEach(toast => toast.remove());

    const toast = document.createElement("div");
    const bgColor = type === "success" ? "bg-green-500" : "bg-red-500";
    toast.className = `toast-notification fixed top-4 right-4 ${bgColor} text-white px-6 py-4 rounded-lg shadow-xl z-50 transform translate-x-full transition-all duration-300 ease-in-out max-w-sm`;

    toast.innerHTML = `
        <div class="flex items-center gap-3">
            <div class="flex-shrink-0">
                ${
                  type === "success"
                    ? '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>'
                    : '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>'
                }
            </div>
            <div class="flex-1">
                <p class="font-medium">${message}</p>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="flex-shrink-0 text-white hover:text-gray-200">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
    `;

    document.body.appendChild(toast);

    // Slide in animation
    setTimeout(() => {
      toast.classList.remove("translate-x-full");
    }, 100);

    // Auto remove after 4 seconds
    setTimeout(() => {
      toast.classList.add("translate-x-full");
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }

  // Make showToast available globally
  window.showToast = showToast;

  // Memory-based scroll position storage (replaces sessionStorage)
  let storedScrollPosition = 0;
  
  // Function to save scroll position
  function saveScrollPosition() {
    storedScrollPosition = window.pageYOffset || document.documentElement.scrollTop;
  }
  
  // Function to restore scroll position
  function restoreScrollPosition() {
    if (storedScrollPosition > 0) {
      window.scrollTo(0, storedScrollPosition);
      storedScrollPosition = 0; // Reset after use
    }
  }
  
  // Save scroll position before page unload
  window.addEventListener('beforeunload', saveScrollPosition);
  
  // Restore scroll position on page load
  restoreScrollPosition();

  // Check if we need to reopen modal after login using URL parameters
  const params = new URLSearchParams(window.location.search);
  let shouldOpenModal = false;
  let modalData = {};

  if (params.get("modal") === "true") {
    shouldOpenModal = true;
    modalData = {
      title: params.get("title") || '',
      author: params.get("author") || '',
      link: params.get("link") || '',
      published: params.get("published") || '',
      category: params.get("category") || '',
      citation: params.get("citation") || '0'
    };

    // Clean up URL by removing modal parameters
    const cleanUrl = new URL(window.location);
    cleanUrl.searchParams.delete("modal");
    cleanUrl.searchParams.delete("title");
    cleanUrl.searchParams.delete("author");
    cleanUrl.searchParams.delete("link");
    cleanUrl.searchParams.delete("published");
    cleanUrl.searchParams.delete("category");
    cleanUrl.searchParams.delete("citation");
    
    // Update URL without refreshing page
    history.replaceState({}, document.title, cleanUrl.toString());
  }

  // Function to update bookmark form action
  function updateBookmarkFormAction(listId) {
    const bookmarkForm = document.getElementById("bookmarkForm");
    if (bookmarkForm && listId) {
      const baseUrl = bookmarkForm.getAttribute('data-base-url') || '/bookmarks/add/';
      bookmarkForm.action = `${baseUrl}${listId}/`;
    }
  }

  // Function to open bookmark modal
  function openBookmarkModal(data) {
    // Populate modal fields
    const modalTitle = document.getElementById("modal-title");
    const modalAuthor = document.getElementById("modal-author");
    const modalLink = document.getElementById("modal-link");
    const modalPublished = document.getElementById("modal-published");
    const modalCategory = document.getElementById("modal-category");
    const modalCitation = document.getElementById("modal-citation");
    
    if (modalTitle) modalTitle.value = data.title || '';
    if (modalAuthor) modalAuthor.value = data.author || '';
    if (modalLink) modalLink.value = data.link || '';
    if (modalPublished) modalPublished.value = data.published || '';
    if (modalCategory) modalCategory.value = data.category || '';
    if (modalCitation) modalCitation.value = data.citation || '0';

    // Update form action if a list is selected
    const listSelect = document.getElementById("modal-list-id");
    if (listSelect && listSelect.value) {
      updateBookmarkFormAction(listSelect.value);
    }

    // Show modal
    const modal = document.getElementById("bookmarkModal");
    if (modal) {
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }
  }

  // Open modal if needed (after login redirect)
  if (shouldOpenModal) {
    // Small delay to ensure DOM is fully loaded
    setTimeout(() => {
      openBookmarkModal(modalData);
    }, 100);
  }

  // Bookmark modal event listeners for authenticated users
  document.querySelectorAll(".open-bookmark-modal").forEach((button) => {
    button.addEventListener("click", () => {
      const data = {
        title: button.dataset.title || '',
        author: button.dataset.author || '',
        link: button.dataset.link || '',
        published: button.dataset.published || '',
        category: button.dataset.category || '',
        citation: button.dataset.citation || '0'
      };
      openBookmarkModal(data);
    });
  });

  // List selection change handler
  const listSelect = document.getElementById("modal-list-id");
  if (listSelect) {
    listSelect.addEventListener("change", function () {
      if (this.value) {
        updateBookmarkFormAction(this.value);
      }
    });
  }

  // Cancel bookmark modal
  const cancelBtn = document.getElementById("cancelBookmark");
  if (cancelBtn) {
    cancelBtn.addEventListener("click", () => {
      const modal = document.getElementById("bookmarkModal");
      if (modal) {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }
    });
  }

  // Close modal when clicking outside
  const modal = document.getElementById("bookmarkModal");
  if (modal) {
    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }
    });
  }

  // Handle bookmark form submission
  const bookmarkForm = document.getElementById("bookmarkForm");
  if (bookmarkForm) {
    bookmarkForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const formData = new FormData(bookmarkForm);
      const submitButton = bookmarkForm.querySelector('button[type="submit"]');
      
      if (!submitButton) return;
      
      const originalText = submitButton.textContent;
      
      // Show loading state
      submitButton.disabled = true;
      submitButton.textContent = "Saving...";
      
      try {
        const response = await fetch(bookmarkForm.action, {
          method: "POST",
          body: formData,
          headers: {
            "X-Requested-With": "XMLHttpRequest",
          },
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          // Close modal
          const modal = document.getElementById("bookmarkModal");
          if (modal) {
            modal.classList.add("hidden");
            modal.classList.remove("flex");
          }
          
          // Show success message
          showToast("Paper saved to bookmarks successfully!", "success");
          
          // Reset form
          bookmarkForm.reset();
        } else {
          showToast(data.error || "Failed to save bookmark", "error");
        }
      } catch (error) {
        console.error("Error saving bookmark:", error);
        showToast("Network error. Please try again.", "error");
      } finally {
        // Reset button state
        submitButton.disabled = false;
        submitButton.textContent = originalText;
      }
    });
  }

  // Create new list functionality
  const createListBtn = document.getElementById("createListBtn");
  const newListNameInput = document.getElementById("new-list-name");
  const bookmarkListSelect = document.getElementById("modal-list-id");
  
  if (createListBtn && newListNameInput && bookmarkListSelect) {
    createListBtn.addEventListener("click", async () => {
      const listName = newListNameInput.value.trim();
      
      if (!listName) {
        showToast("Please enter a list name", "error");
        return;
      }
      
      const originalText = createListBtn.textContent;
      createListBtn.disabled = true;
      createListBtn.textContent = "Creating...";
      
      try {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
          throw new Error("CSRF token not found");
        }
        
        const formData = new FormData();
        formData.append("name", listName);
        formData.append("csrfmiddlewaretoken", csrfToken.value);
        
        // Get the create list URL from a data attribute or construct it
        const createListUrl = createListBtn.getAttribute('data-create-url') || '/bookmarks/lists/create/';
        
        const response = await fetch(createListUrl, {
          method: "POST",
          body: formData,
          headers: {
            "X-Requested-With": "XMLHttpRequest",
          },
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          // Add new option to select
          const newOption = document.createElement("option");
          newOption.value = data.list_id;
          newOption.textContent = listName;
          newOption.selected = true;
          
          // Remove "No lists available" option if it exists
          const noListsOption = bookmarkListSelect.querySelector('option[disabled]');
          if (noListsOption && noListsOption.textContent.includes('No lists')) {
            noListsOption.remove();
          }
          
          bookmarkListSelect.appendChild(newOption);
          
          // Update form action with new list ID
          updateBookmarkFormAction(data.list_id);
          
          // Clear input
          newListNameInput.value = "";
          
          showToast("New list created successfully!", "success");
        } else {
          showToast(data.error || "Failed to create list", "error");
        }
      } catch (error) {
        console.error("Error creating list:", error);
        showToast("Network error. Please try again.", "error");
      } finally {
        createListBtn.disabled = false;
        createListBtn.textContent = originalText;
      }
    });
    
    // Allow creating list with Enter key
    newListNameInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        createListBtn.click();
      }
    });
  }

  // Handle search form submission with loading state
  const searchForm = document.getElementById("searchForm");
  if (searchForm) {
    searchForm.addEventListener("submit", (e) => {
      const submitButton = searchForm.querySelector('button[type="submit"]');
      const searchInput = document.getElementById("searchInput");
      
      // Check if query is provided
      if (!searchInput || !searchInput.value.trim()) {
        e.preventDefault();
        showToast("Please enter a search query", "error");
        return;
      }
      
      // Check if at least one source is selected
      const checkedSources = document.querySelectorAll('input[name="sources"]:checked');
      if (checkedSources.length === 0) {
        e.preventDefault();
        showToast("Please select at least one source to search", "error");
        return;
      }
      
      // Show loading state
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Searching...';
        
        // Store original content to restore if needed
        submitButton.dataset.originalContent = '<i class="fas fa-search"></i>';
      }
      
      // Save scroll position before form submission
      saveScrollPosition();
    });
  }

  // Smooth scrolling for anchor links
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        target.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    });
  });

  // Add loading animation to external links
  document.querySelectorAll('a[target="_blank"]').forEach(link => {
    link.addEventListener('click', function() {
      const icon = this.querySelector('i');
      if (icon && icon.classList.contains('fa-external-link-alt')) {
        icon.classList.add('fa-spin');
        setTimeout(() => {
          icon.classList.remove('fa-spin');
        }, 1000);
      }
    });
  });

  // Enhanced keyboard navigation for search form
  document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + K to focus search
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      const searchInputElement = document.getElementById('searchInput');
      if (searchInputElement) {
        searchInputElement.focus();
        searchInputElement.select();
      }
    }
    
    // Escape key to close modal
    if (e.key === 'Escape') {
      const modal = document.getElementById('bookmarkModal');
      if (modal && !modal.classList.contains('hidden')) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    }
  });

  // Show keyboard shortcut hint
  const mainSearchInput = document.getElementById('searchInput');
  if (mainSearchInput) {
    // Add placeholder enhancement
    const originalPlaceholder = mainSearchInput.placeholder;
    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
    const shortcut = isMac ? 'âŒ˜K' : 'Ctrl+K';
    
    mainSearchInput.addEventListener('blur', () => {
      if (!mainSearchInput.value) {
        mainSearchInput.placeholder = `${originalPlaceholder} (${shortcut})`;
      }
    });
    
    mainSearchInput.addEventListener('focus', () => {
      mainSearchInput.placeholder = originalPlaceholder;
    });
  }

  // Add paper card animations on scroll
  const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.style.opacity = '1';
        entry.target.style.transform = 'translateY(0)';
      }
    });
  }, observerOptions);

  // Observe paper cards for animation
  document.querySelectorAll('.paper-card-hover').forEach(card => {
    card.style.opacity = '0';
    card.style.transform = 'translateY(20px)';
    card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
    observer.observe(card);
  });

  // Add copy to clipboard functionality for paper titles
  document.querySelectorAll('.paper-card-hover').forEach(card => {
    const title = card.querySelector('h3 a');
    if (title) {
      // Add copy button
      const copyBtn = document.createElement('button');
      copyBtn.className = 'ml-2 text-gray-400 hover:text-amber-700 transition-colors opacity-0 group-hover:opacity-100';
      copyBtn.innerHTML = '<i class="fas fa-copy text-xs"></i>';
      copyBtn.title = 'Copy title';
      
      copyBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        try {
          await navigator.clipboard.writeText(title.textContent.trim());
          copyBtn.innerHTML = '<i class="fas fa-check text-xs text-green-600"></i>';
          setTimeout(() => {
            copyBtn.innerHTML = '<i class="fas fa-copy text-xs"></i>';
          }, 2000);
        } catch (err) {
          console.error('Failed to copy text:', err);
          showToast('Failed to copy to clipboard', 'error');
        }
      });
      
      title.parentElement.classList.add('group');
      title.parentElement.appendChild(copyBtn);
    }
  });

  // Debounced search input validation
  let validationTimeout;
  if (mainSearchInput && searchForm) {
    mainSearchInput.addEventListener('input', function() {
      clearTimeout(validationTimeout);
      
      validationTimeout = setTimeout(() => {
        const value = this.value.trim();
        const submitButton = searchForm.querySelector('button[type="submit"]');
        
        if (submitButton) {
          if (value.length > 0) {
            submitButton.disabled = false;
            submitButton.classList.remove('opacity-50');
          } else {
            submitButton.disabled = true;
            submitButton.classList.add('opacity-50');
          }
        }
      }, 300);
    });
  }

  // Initialize search button state
  if (mainSearchInput && searchForm) {
    const submitButton = searchForm.querySelector('button[type="submit"]');
    if (submitButton) {
      const initialValue = mainSearchInput.value.trim();
      if (initialValue.length === 0) {
        submitButton.disabled = true;
        submitButton.classList.add('opacity-50');
      }
    }
  }

  console.log('ReFindr search page initialized successfully');

});
</script>
{% endblock %}